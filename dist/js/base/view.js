define(["base/app","base/model","base/util","base/mixins/config"],function(e,t,n,r){var i=Backbone.View.extend({constructor:function(e){var t=this;t.removeQue=[],t.removed=!1,t.rendered=!1,Backbone.View.call(t,e),_.each(b,function(e){e(t)})},setupView:function(){},tearUpView:function(){},postSetup:function(){},postMetaLoad:function(){},render:function(){var n=this;n.$el.addClass("rendering"),n.model||(n.model=new t);var r=(new Date).getTime();n.beforeRender();var i=y(n,function(){n.removeChildViews&&n.removeChildViews(),e.getTemplateDef(n.getTemplate(),n.getTemplateType()).done(y(n,function(e){n.renderTemplate(e),l(n);if(n.setState){n.clearState();var t=_.keys(n.getOption("states"))[0];n.setState(n.getState()||n.getOption("state")||t)}n.postRender(),n.$el.removeClass("rendering");var i=(new Date).getTime()-r;i>20&&console.warn(this.$el[0],i),n.rendered=!0,n.trigger("rendered")}))}),s=function(){n.postMetaLoad.apply(n,arguments),i()};if(!n.rendered){var o=n.loadMeta();o.done(y(n,s))}else i();return n},postRender:function(){},beforeRender:function(){},renderTemplate:function(e){this.$el.html(e(this.serialize()))},getOption:function(e){return this.options[e]||this[e]},loadingHandler:function(e){this.$el.toggleClass("loading",e)},metaLoadErrorHandler:function(){this.$el.html("Error Loading Meta Data")},addMethod:function(e,t){this[e]||(this[e]=t)},serialize:function(){var e=this.getOption("useDeepJSON");return this.model.toJSON(e)},remove:function(){this.removeChildViews(),Backbone.View.prototype.remove.call(this),this.removeReferences(),this.stopListening(),this.removeQue=null,this.removed=!0},removeReferences:function(e){e?this.removeQue.push(e):_.each(this.removeQue,function(e){e.call(this)})},show:function(){this.$el.show()},hide:function(){this.$el.hide()},postMessage:function(){var e=_.toArray(arguments);e.unshift("all"),e.unshift("postMessage"),this.trigger.apply(this,e)},postMessageTo:function(e){var t=_.rest(arguments);t.unshift(e),t.unshift("postMessage"),this.trigger.apply(this,t)}});i.deepExtendMethods=function(e){var t=this.prototype;_.each(e,function(e,n){var r=t[n];if(!r)throw new Error("Method with name: "+n+" doesn't exists to deep extend");t[n]=function(){r.apply(this,arguments),e.apply(this,arguments)}})},i.templateTypes={UNDERSCORE:"underscore",HANDLEBARS:"handlebars"};var s=function(e){var t=e.model||e.collection,n;n=e.dataEvents,_.each(n,function(n,r){var i,s,o;o=/\s+/,s=n.split(o),i=r.split(o),_.each(s,function(n){_.each(i,function(r){e.listenTo(t,r,function(){if(!e[n])throw n+" Not Defined";var t=Array.prototype.slice.call(arguments);t.unshift(r),e[n].apply(e,t)})})})})},o=function(t){var n=t.getOption("appEvents");_.isEmpty(n)||_.each(n,function(n,r){var i,s,o;o=/\s+/,s=n.split(o),i=r.split(o),_.each(s,function(n){_.each(i,function(r){t.listenTo(e,r,function(){if(!t[n])throw n+" Not Defined";var e=Array.prototype.slice.call(arguments);e.unshift(r),t[n].apply(t,e)})})})})},u=function(e){var t;t=e.customEvents,_.each(t,function(t,n){var r,i,s;s=/\s+/,i=t.split(s),r=n.split(s),_.each(i,function(t){_.each(r,function(n){e.listenTo(e,n,function(){if(!e[t])throw t+" Not Defined";var n=Array.prototype.slice.call(arguments);e[t].apply(e,n)})})})})},a=function(e){var t=e.getOption("states");if(!t)return;var r,i,s=function(){i&&i.remove()},o=function(t){if(e.$(".state-view").length===0)throw new Error('Rendering state needs element with class "state-view".');i=n.createView({View:t,model:e.model,parentEl:".state-view",parentView:e}),e.listenTo(i,"setState",function(t){e.setState(t)})};e.setState=function(n){if(typeof n!="string")throw new Error("state should be a string");if(r===n)return;r=n;var i=t[n];if(_.isFunction(i))i.call(e,r);else{if(!i)throw new Error("Invalid State");s(),o(i)}},e.getState=function(){return r},e.clearState=function(){s(),r=undefined},e.removeReferences(function(){t=null,r=null,i=null,e=null})},f=function(e){var t=e.getOption("template")||e.template;e.setTemplate=function(n){t=n,e.render()},e.getTemplate=function(){return t},e.getTemplateType=function(){return e.getOption("templateType")||"Handlebars"},e.removeReferences(function(){t=null,e=null})},l=function(e){var t={},r=e.getOption("views");e.getSubView=function(e){var n=t[e];if(n)return n;throw new Error("No View Defined for id :"+e)},e.setSubView=function(n,r){t[n]=r,e.addToMessageRoom(r,n)},e.getAllSubViews=function(){return t},e.getSubCollection=function(t){return e.getSubView(t).collection},e.getSubModel=function(t){return e.getSubView(t).model},e.getSubAttribute=function(t,n){return e.getSubModel(t).get(n)},e.removeReferences(function(){r=null,t=null,e=null}),e.addToMessageRoom(e,"owner"),_.each(r,function(t,r){typeof t=="function"&&(t=t.call(e)),t.parentView=e;var i=n.createView(t);e.setSubView(r,i)})},c=function(e){var t=e.model,n=e.getOption("preRendered"),r=function(){h.call(e,t.toJSON(),!0),e.listenTo(t,"change",function(){h.call(e,t.changedAttributes())})};t&&(n?r():e.listenToOnce(e,"rendered",r))},h=function(e,t){_.each(e,function(e,n){var r=this[n+"ChangeHandler"];r&&typeof r=="function"&&r.call(this,e,t)},this);var n=this.changeHandler;n&&typeof n=="function"&&n.call(this,e,t)},p=function(e){var t=function(e){e.actionHandled&&(e.stopPropagation(),$("body").trigger("click"))};e.actionHandler&&e.$el.on("click",".action",function(n){n.preventDefault();var r=$(n.currentTarget),i=r.attr("href").substr(1);e.actionHandler.call(e,i,n),t(n)}),e.$el.on("click",".dummy",function(e){e.preventDefault()}),e.removeReferences(function(){e.$el.off(),e=null})},d=function(e){var t=e.getOption("renderEvents")||e.renderEvents;t&&t.length>0&&e.listenTo(e.model,t.join(" "),function(){e.render.call(e)})},v=function(t){var n=t.getOption("requests")||t.requests,r=0,i=y(t,function(){r++,r>0&&t.loadingHandler.call(t,!0)}),s=y(t,function(){r--,r<1&&t.loadingHandler.call(t,!1)});t.addRequest=function(t,n){var r=t;_.isArray(r)||(r=[r]);var o=_.map(r,function(t){var n=e.getRequestDef(t);return t.callback&&n.always(t.callback),i(),n.always(s),n}),u=$.when.apply(null,o);return n&&u.then(n),u},t.loadMeta=function(){if(!t.metaDef){var e=n?t.addRequest(n,y(t,function(){var e=t.getOption("requestsParser");e&&e.apply(t,arguments)})):$.when({});t.metaDef=e}return t.metaDef},t.removeReferences(function(){n=null,r=null,t=null})},m=function(e){var t=[];e.addChildView=function(e){t.push(e)},e.removeChildViews=function(){_.each(t,function(e){e.parentView=null,e&&e.remove&&e.remove()}),t=[]},e.removeReferences(function(){t=null,e=null})},g=function(e){var t={};e.addToMessageRoom=function(n,r){t[r]=n,e.listenTo(n,"postMessage",function(){var e=_.first(arguments),i="message",s=_.rest(arguments);s.unshift(n),s.unshift(r),s.unshift(i);if(e==="all")_.each(t,function(e,t){r!==t&&e.trigger.apply(e,s)});else{var o=t[e];o&&o.trigger.apply(o,s)}})},e.removeReferences(function(){t=null,e=null})},y=function(e,t){return function(){e.removed||t.apply(e,arguments)}},b=[s,o,u,g,v,f,c,p,d,a,m,r];return i});