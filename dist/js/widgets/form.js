define(["base/app","base/util","base","widgets/form/element","widgets/messageStack","widgets/calendar","text!./form/checkListView.html","text!./form/checkBoxView.html","text!./form/radioListView.html","text!./form/selectView.html","text!./form/textAreaView.html","text!./form/buttonView.html","text!./form/dateInputView.html","text!./form/messageView.html"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d=r.View,v=r.Model,m=r.Collection,g=d.extend({template:c,valueFunction:function(){return this.$("button").text()},valueChangeHandler:function(e){this.$("button").text(e)},activeChangeHandler:function(e){this.$("button").prop("disabled",!e)}}),y=d.extend({events:{"change input":"updateValue","blur input":"resetIfEmpty","focus input":"selectIfDefault","click input":"clearIfDefault"},selectIfDefault:function(){this.model.isElementDefault()&&this.$("input").select()},clearIfDefault:function(){this.model.isElementDefault()&&this.$("input").val("")},resetIfEmpty:function(){var e=this.$("input").val();if(e===""){var t=this.model.toJSON();t.defaultValue&&this.$("input").val(t.defaultValue)}this.updateValue()}}),b=y.extend({template:h,events:{"click .dateInput":"showDatePicker","change .dateInput":"dateChangeHandler"},postRender:function(){var t=this;t.hideDatePicker();var n=this.getSubView("monthView");this.listenTo(n,"dateClicked",function(e){t.hideDatePicker(),t.$(".dateInput").val(e.format("L")),t.updateValue()});var r=n.$el;this.listenTo(e,"bodyClick",function(e){var n=$(e.target);n.parents().index(t.$el)==-1&&r.is(":visible")&&r.hide()})},views:{monthView:{View:s.Month.View,Model:s.Month.Model,parentEl:".monthView"}},showDatePicker:function(){var e=this.getSubView("monthView"),t=this.model.get("value"),n=moment(t,"MM/DD/YYYY");e.model.set({year:n.year(),month:n.month(),selectedEpoch:n.valueOf()}),e.show()},hideDatePicker:function(){var e=this.getSubView("monthView");e.hide()},valueFunction:function(){return this.$(".dateInput").val()},valueChangeHandler:function(e){var t=moment(e,"MM/DD/YYYY");t.isValid()||(t=moment(),this.model.set("value",t.format("L"))),this.$(".dateInput").val(t.format("L"))},dateChangeHandler:function(){var e=this.$(".dateInput").val(),t=moment(e,"MM/DD/YYYY");t.isValid()?(this.model.set("value",e),this.hideDatePicker()):this.valueChangeHandler(this.model.get("value"))}}),w=d.extend({template:u,valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),E=d.extend({template:l,valueFunction:function(){return this.$("textarea").val()},valueChangeHandler:function(e){this.$("textarea").val(e)}}),S=d.extend({template:f,valueFunction:function(){return this.$("select").val()},valueChangeHandler:function(e){this.$("select").val(e)},disabledChangeHandler:function(e){this.$el.toggleClass("disabled",e),this.$("select").attr("disabled",e)}}),x=d.extend({template:a,valueFunction:function(){return this.$("input:checked").val()},valueChangeHandler:function(e){this.$("input[value="+e+"]").attr("checked",!0)}}),T=d.extend({template:o,valueFunction:function(){var e=this.$("input:checked"),t=_.map(e,function(e){return $(e).val()});return t},valueChangeHandler:function(e){_.isArray(e)&&_.each(e,function(e){this.$("input[value="+e+"]").attr("checked",!0)},this)}}),N=d.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(e),this.$("input").trigger("change")},valueFunction:function(){return""+this.$("input").val()}}),C=d.extend({template:" ",valueChangeHandler:function(e){},valueFunction:function(){}}),y=d.extend({selectIfDefault:function(){this.model.isElementDefault()&&this.$("input").select()},clearIfDefault:function(){this.model.isElementDefault()&&this.$("input").val("")},resetIfEmpty:function(){var e=this.$("input").val();if(e===""){var t=this.model.toJSON();t.defaultValue&&this.$("input").val(t.defaultValue)}this.updateValue()}}),k=d.extend({template:p,valueChangeHandler:function(e){this.$(".message").html(e)},valueFunction:function(){return this.$(".message").html()}}),L=d.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(JSON.stringify(e)),this.updateValue()},valueFunction:function(){return JSON.parse(this.$("input").val())}}),A=d.extend({valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),O={select:S,textarea:E,checkbox:w,dateInput:b,radioList:x,checkList:T,hidden:N,json:L,button:g,message:k,container:C},M=function(e){return O[e]||y},D=function(e,t){O[e]=t},P=function(e){O=_.extend({},O,e)},H=n.Model.extend({constructor:function(){n.Model.apply(this,arguments)},defaults:{elements:new m},setElementAttribute:function(e,t,n){var r=this.get("elements");r.get(e).set(t,n)},getValueObject:function(){var e=this.get("elements");e.each(function(e){e.trigger("forceUpdate")});var t=this.validateElements(),n={};return t.length===0?e.each(function(e){e.is("active")&&e.isNotEqual("type","button")&&(n[e.id]=e.get("value"))}):n.errors=t,n},validateElements:function(){var e=this.get("elements"),t=[];return e.each(function(e){t=t.concat(e.isElementValid())}),t},elementsChangeHandler:function(){var e=this.get("elements");e.on("change",function(e){var t="change",n=Array.prototype.slice.call(arguments,[0]);n[0]="elements:"+t,this.trigger.apply(this,n),n[0]="elements:"+e.get("name")+":"+t,this.trigger.apply(this,n)},this)}}),B="grp-",j=n.View.extend({constructor:function(e){this.typeViewIndex={},n.View.apply(this,arguments)},tagName:"div",className:"form-view",events:{"submit form":"formSubmitHandler"},template:'<div class="message-stack"></div><form action="{{actionId}}" class="form-vertical" method=""> <div class="group-list"></div> <div class="grp-buttons"> </div> </form>',postRender:function(){this.formEl=this.$("form"),this.renderGroupContainers(),this.renderMessageStack();var e=this.model,t=e.get("elements");t.each(function(e){this.addElement(e)},this)},addElement:function(e){var n=e.toJSON(),r=this,i=this.typeViewIndex[n.type]||M(n.type),s=n.name,o,u=this.$(".element-"+s);if(u.length!==0)o=new i({model:e,el:u}),o.trigger("rendered"),o.postRender();else{o=t.createView({View:i,model:e,parentView:r});var a=n.group;this.$("."+B+a).append(o.el)}},removeElement:function(e){},renderGroupContainers:function(){var e=this.model,t=e.get("elements"),n=_.unique(t.pluck("group")),r=this.$(".group-list");_.each(n,function(e){this.$("."+B+e).length===0&&r.append('<div class="'+B+e+'"></div>')},this)},renderMessageStack:function(){var e=t.createView({View:i.View,Model:i.Model,parentEl:".message-stack",parentView:this}),n=e.model;e.listenTo(this,"showMessages",function(e){n.removeAllMessages(),_.each(e,function(e){var t=new i.Model(e);n.addMessage(t.toJSON())})}),e.listenTo(this,"clearMessages",function(){n.removeAllMessages()});var r=this.model.get("errors");r&&r.length>0&&this.trigger("showMessages",r)},formSubmitHandler:function(e){e.preventDefault(),this.trigger("clearMessages");var t=this.model.getValueObject(),n=this.model.get("actionId");this.options.prePostParser&&(t=this.options.prePostParser(t)),this.trigger("formSubmit",t)},addToTypeViewIndex:function(e,t){this.typeViewIndex[e]=t},submitSuccessHandler:function(){console.log(arguments)},submitFailureHandler:function(e,t){_.each(t,function(e){e.messageType="failure",e.expires=0}),this.trigger("showMessages",t)},setElementValue:function(e,t){var n=this.model.get("elements");n.get(e).set("value",t)},resetForm:function(e){var t=this.model.get("elements");t.each(function(e){e.resetValue(!0)}),e&&this.trigger("clearMessages")}});return j.addToTypeViewIndex=function(e,t){D(e,t)},{Model:H,View:j,ElementModel:v,ElementCollection:m,ElementView:d}});